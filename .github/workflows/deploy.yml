name: Build and Deploy to AKS

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'docs/**'
      - 'README.md'
      - 'SERVICE_ARCHITECTURE.md'
      - 'wiki_content/**'
  workflow_dispatch:

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  RESOURCE_GROUP: "DogBreedRG"
  CLUSTER_NAME: "DogBreedCluster"

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      k8s: ${{ steps.filter.outputs.k8s }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'
            k8s:
              - 'k8s/**'
              - '.github/workflows/**'

  unit-test:
    needs: check-changes
    if: needs.check-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.12
        uses: actions/setup-python@v3
        with:
          python-version: "3.12"
      - name: Install dependencies
        working-directory: ./backend
        run: |
          pip install -r unit-test-requirement.txt
      - name: Lint with flake8
        working-directory: ./backend
        run: |
          flake8 src . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 src . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      - name: Run tests
        working-directory: ./backend
        run: |
          pytest tests/ --junitxml=test-report.xml
      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: backend/test-report.xml

  # New dedicated job for Model Training (Visualization & Modularity)
  train-model:
    needs: [check-changes, unit-test]
    if: needs.check-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        working-directory: ./backend
        run: |
          pip install -r requirements.txt

      - name: Train Model (MobileNetV2)
        working-directory: ./backend
        run: |
          python -m src.models.train
      
      # Upload the trained model as an artifact so the next job can use it
      - name: Upload Trained Model Artifact
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: backend/model.h5
          retention-days: 1

  build-backend:
    needs: [check-changes, train-model] # Waits for training to complete
    if: needs.check-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Download the model trained in the previous job
      - name: Download Trained Model
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: backend

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/dog-breed-prediction-api:latest
            ${{ secrets.DOCKER_USERNAME }}/dog-breed-prediction-api:${{ github.sha }}

  build-frontend:
    needs: [check-changes] # Runs in parallel with training/backend-build
    if: needs.check-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/dog-breed-prediction-frontend:latest
            ${{ secrets.DOCKER_USERNAME }}/dog-breed-prediction-frontend:${{ github.sha }}

  deploy:
    needs: [build-backend, build-frontend, check-changes]
    if: |
      always() &&
      needs.check-changes.result == 'success' &&
      (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped') &&
      (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ env.RESOURCE_GROUP }}
          cluster-name: ${{ env.CLUSTER_NAME }}

      # Update Image Tags in Manifests based on changes
      - name: Update Manifests with Image Tags
        run: |
          # 1. Backend Tag
          BACKEND_TAG="latest"
          if [[ "${{ needs.check-changes.outputs.backend }}" == "true" ]]; then
            BACKEND_TAG="${{ github.sha }}"
            echo "Backend changed. Using SHA: $BACKEND_TAG"
          else
            echo "Backend unchanged. Using existing tag: $BACKEND_TAG"
          fi

          # 2. Frontend Tag
          FRONTEND_TAG="latest"
          if [[ "${{ needs.check-changes.outputs.frontend }}" == "true" ]]; then
            FRONTEND_TAG="${{ github.sha }}"
            echo "Frontend changed. Using SHA: $FRONTEND_TAG"
          else
             echo "Frontend unchanged. Using existing tag: $FRONTEND_TAG"
          fi

          # Replace in manifests
          sed -i "s|image: .*/dog-breed-prediction-api:latest|image: ${{ secrets.DOCKER_USERNAME }}/dog-breed-prediction-api:$BACKEND_TAG|g" k8s/backend/backend-deployment.yml
          sed -i "s|image: .*/dog-breed-prediction-frontend:latest|image: ${{ secrets.DOCKER_USERNAME }}/dog-breed-prediction-frontend:$FRONTEND_TAG|g" k8s/frontend/frontend-deployment.yml

      - name: Deploy to AKS
        run: |
          # Apply Manifests
          kubectl apply -f k8s/common/ingress.yml
          kubectl apply -f k8s/backend/backend-deployment.yml
          kubectl apply -f k8s/backend/backend-service.yml
          kubectl apply -f k8s/frontend/frontend-deployment.yml
          
          # Monitoring Stack
          kubectl apply -f k8s/monitoring/prometheus-config.yml
          kubectl apply -f k8s/monitoring/prometheus-deployment.yml
          kubectl apply -f k8s/monitoring/prometheus-service.yml
          kubectl apply -f k8s/monitoring/grafana-config.yml
          kubectl apply -f k8s/monitoring/grafana-dashboards.yml

  # Dedicated Smoke Test Job (Visualization)
  smoke-test:
    needs: [deploy]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Wait for Pods to be Ready
        run: sleep 60 # Give K8s a moment to roll out
        
      - name: Post-Deploy Smoke Test
        run: |
          chmod +x post_deploy_smoke_test.sh
          ./post_deploy_smoke_test.sh
